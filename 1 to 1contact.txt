class ChannelActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val user = intent.getStringExtra(EXTRA_USER)!!
        val otherUser = intent.getStringExtra(EXTRA_OTHER_USER)!!
        val virgilToken = intent.getStringExtra(EXTRA_VIRGIL_TOKEN)!!

        val client = StreamChat.getInstance(application)
        val eThree = EThree.initialize(this, object : OnGetTokenCallback {
            override fun onGetToken() = virgilToken
        }).get()

        val binding: ActivityChannelBinding =
            DataBindingUtil.setContentView(this, R.layout.activity_channel)
        binding.lifecycleOwner = this

        doAsync {
            val users = listOf(user, otherUser).sorted()
            val receiverPublicKeys = eThree.lookupPublicKeys(otherUser).get()
            val channel = client.channel(
                ModelType.channel_messaging,
                hashMapOf<String, Any>(
                    "name" to users.joinToString(", "),
                    "image" to "https://robohash.org/${users.joinToString("-")}"
                ),
                users
            )

            channel.query(ChannelQueryRequest(), object : QueryChannelCallback {
                override fun onSuccess(response: ChannelState?) {
                    channel.update(object : ChannelCallback {
                        override fun onSuccess(response: ChannelResponse?) {
                            uiThread {
                                configureViews(
                                    it,
                                    binding,
                                    channel,
                                    eThree,
                                    receiverPublicKeys
                                )
                            }
                        }

                        override fun onError(errMsg: String?, errCode: Int) {

                        }
                    })
                }

                override fun onError(errMsg: String?, errCode: Int) {

                }
            })
        }
    }

    private fun configureViews(
        context: ChannelActivity,
        binding: ActivityChannelBinding,
        channel: Channel?,
        eThree: EThree,
        receiverPublicKeys: LookupResult
    ) {
        val viewModel =
            ViewModelProviders.of(context, ChannelViewModelFactory(context.application, channel))
                .get(ChannelViewModel::class.java)

        binding.viewModel = viewModel
        binding.messageList.setViewHolderFactory(EncryptedMessageViewHolderFactory(eThree))
        binding.messageList.setViewModel(viewModel, context)
        binding.messageInput.setViewModel(viewModel, context)
        binding.messageInput.eThree = eThree
        binding.messageInput.receiverPublicKeys = receiverPublicKeys
        binding.channelHeader.setViewModel(viewModel, context)
    }
}